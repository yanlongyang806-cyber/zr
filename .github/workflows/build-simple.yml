name: 编译 GameServer (简化版)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装 Visual Studio 2022
      uses: microsoft/setup-msbuild@v1.1
      
    - name: 查找解决方案文件
      shell: cmd
      run: |
        echo 查找 .sln 文件...
        dir /s /b *.sln | findstr /i "GameServer"
        
    - name: 检查解决方案文件
      shell: cmd
      run: |
        echo ========================================
        echo 检查解决方案文件
        echo ========================================
        echo 当前目录: %CD%
        if exist "src\Night\GameServer\NNOGameServer.sln" (
          echo [OK] 找到: src\Night\GameServer\NNOGameServer.sln
        ) else (
          echo [ERROR] 未找到解决方案文件
          echo 查找所有 .sln 文件:
          dir /s /b *.sln 2>nul | findstr /i "GameServer"
          exit /b 1
        )
        
    - name: 编译 GameServer
      shell: cmd
      run: |
        echo ========================================
        echo 开始编译 GameServer
        echo ========================================
        cd /d %CD%\src\Night\GameServer
        echo 当前目录: %CD%
        if not exist "NNOGameServer.sln" (
          echo [ERROR] 解决方案文件不存在
          exit /b 1
        )
        echo 使用解决方案: %CD%\NNOGameServer.sln
        msbuild NNOGameServer.sln /p:Configuration=Release /p:Platform=Win32 /m /v:minimal /t:Build
        if %ERRORLEVEL% NEQ 0 (
          echo [ERROR] 编译失败
          exit /b 1
        )
        echo ========================================
        echo GameServer 编译完成
        echo ========================================
        
    - name: 查找编译输出
      shell: cmd
      run: |
        echo 查找 GameServer.exe...
        dir /s /b GameServer.exe
        
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: GameServer-Build
        path: |
          **/GameServer.exe
          **/GameServer.pdb
        retention-days: 7

