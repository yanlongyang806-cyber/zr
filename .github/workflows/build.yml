name: 编译 GameServer 和 AutoLoadLua

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: 设置 MSBuild 路径
      uses: microsoft/setup-msbuild@v1.1
      
    - name: 安装 Visual Studio 构建工具
      uses: microsoft/setup-msbuild@v1.1
      
    - name: 设置 Visual Studio 环境
      uses: microsoft/setup-msbuild@v1.1
      
    - name: 编译 GameServer
      shell: cmd
      run: |
        echo ========================================
        echo 开始编译 GameServer
        echo ========================================
        cd src\Night\GameServer
        msbuild NNOGameServer.sln /p:Configuration=Debug /p:Platform=Win32 /m /v:minimal
        if %ERRORLEVEL% NEQ 0 (
          echo [ERROR] GameServer 编译失败
          exit /b 1
        )
        echo ========================================
        echo GameServer 编译完成
        echo ========================================
        
    - name: 编译 AutoLoadLua.dll
      shell: cmd
      run: |
        echo ========================================
        echo 开始编译 AutoLoadLua.dll
        echo ========================================
        cd tools\AutoLoadLua
        if exist AutoLoadLua.cpp (
          cl /LD /EHsc /O2 /W3 AutoLoadLua.cpp /link /OUT:AutoLoadLua.dll /DEF:AutoLoadLua.def kernel32.lib
          if %ERRORLEVEL% NEQ 0 (
            echo [ERROR] AutoLoadLua.dll 编译失败
            exit /b 1
          )
          echo ========================================
          echo AutoLoadLua.dll 编译完成
          echo ========================================
        ) else (
          echo [WARNING] AutoLoadLua.cpp 不存在，跳过编译
        )
        
    - name: 编译 Injector.exe
      shell: cmd
      run: |
        echo ========================================
        echo 开始编译 Injector.exe
        echo ========================================
        cd tools\AutoLoadLua
        if exist Injector.cpp (
          cl /EHsc /O2 /W3 Injector.cpp /link /OUT:Injector.exe
          if %ERRORLEVEL% NEQ 0 (
            echo [ERROR] Injector.exe 编译失败
            exit /b 1
          )
          echo ========================================
          echo Injector.exe 编译完成
          echo ========================================
        ) else (
          echo [WARNING] Injector.cpp 不存在，跳过编译
        )
        
    - name: 创建构建产物目录
      shell: cmd
      run: |
        if not exist build_artifacts mkdir build_artifacts
        
    - name: 复制 GameServer.exe
      shell: cmd
      run: |
        echo 查找 GameServer.exe...
        echo 查找位置: src\Night\GameServer\Debug\ 或 src\Night\GameServer\Full Debug\
        set FOUND=0
        if exist "src\Night\GameServer\Debug\GameServer.exe" (
          copy "src\Night\GameServer\Debug\GameServer.exe" "build_artifacts\GameServer.exe"
          echo [OK] 已复制: src\Night\GameServer\Debug\GameServer.exe
          set FOUND=1
        ) else if exist "src\Night\GameServer\Full Debug\GameServer.exe" (
          copy "src\Night\GameServer\Full Debug\GameServer.exe" "build_artifacts\GameServer.exe"
          echo [OK] 已复制: src\Night\GameServer\Full Debug\GameServer.exe
          set FOUND=1
        ) else (
          echo [WARNING] 未找到 GameServer.exe
          echo 查找所有位置:
          dir /s /b GameServer.exe 2>nul
        )
        
    - name: 复制 AutoLoadLua.dll
      shell: cmd
      run: |
        if exist "tools\AutoLoadLua\AutoLoadLua.dll" (
          copy "tools\AutoLoadLua\AutoLoadLua.dll" "build_artifacts\AutoLoadLua.dll"
          echo [OK] AutoLoadLua.dll 已复制
        )
        
    - name: 复制 Injector.exe
      shell: cmd
      run: |
        if exist "tools\AutoLoadLua\Injector.exe" (
          copy "tools\AutoLoadLua\Injector.exe" "build_artifacts\Injector.exe"
          echo [OK] Injector.exe 已复制
        )
        
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: build_artifacts/
        retention-days: 30
