name: 编译 AutoLoadLua DLL

on:
  push:
    branches: [ main, master ]
    paths:
      - 'tools/AutoLoadLua/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'tools/AutoLoadLua/**'
  workflow_dispatch:

jobs:
  build-dll:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装 Visual Studio 2022
      uses: microsoft/setup-msbuild@v1.1
      
    - name: 编译 AutoLoadLua.dll
      shell: cmd
      run: |
        echo ========================================
        echo 编译 AutoLoadLua.dll
        echo ========================================
        cd tools\AutoLoadLua
        
        if not exist AutoLoadLua.cpp (
          echo [ERROR] AutoLoadLua.cpp 不存在
          exit /b 1
        )
        
        cl /LD /EHsc /O2 /W3 AutoLoadLua.cpp /link /OUT:AutoLoadLua.dll /DEF:AutoLoadLua.def kernel32.lib
        
        if %ERRORLEVEL% NEQ 0 (
          echo [ERROR] 编译失败
          exit /b 1
        )
        
        echo ========================================
        echo AutoLoadLua.dll 编译成功
        echo ========================================
        
    - name: 编译 Injector.exe
      shell: cmd
      run: |
        echo ========================================
        echo 编译 Injector.exe
        echo ========================================
        cd tools\AutoLoadLua
        
        if exist Injector.cpp (
          cl /EHsc /O2 /W3 Injector.cpp /link /OUT:Injector.exe
          if %ERRORLEVEL% NEQ 0 (
            echo [ERROR] Injector.exe 编译失败
            exit /b 1
          )
          echo [OK] Injector.exe 编译成功
        ) else (
          echo [WARNING] Injector.cpp 不存在
        )
        
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: AutoLoadLua-Build
        path: |
          tools/AutoLoadLua/AutoLoadLua.dll
          tools/AutoLoadLua/Injector.exe
        retention-days: 30

